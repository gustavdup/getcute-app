<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Details - {{ user.get('phone', 'Unknown phone') }}</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background-color: #f5f5f5;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        /* Navigation Bar */
        .nav-bar {
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 15px 20px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 20px;
        }
        
        .nav-left, .nav-right {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .back-btn {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 8px 15px;
            cursor: pointer;
            font-size: 14px;
            color: #495057;
            transition: all 0.2s;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }
        
        .back-btn:hover {
            background: #e9ecef;
            border-color: #adb5bd;
        }
        
        .nav-link {
            color: #25D366;
            text-decoration: none;
            font-weight: 500;
            font-size: 14px;
            transition: color 0.2s;
        }
        
        .nav-link:hover {
            color: #128C7E;
        }
        
        /* Search Container */
        .nav-center {
            flex: 1;
            max-width: 400px;
        }
        
        .search-container {
            display: flex;
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 25px;
            overflow: hidden;
        }
        
        .search-input {
            flex: 1;
            border: none;
            outline: none;
            padding: 10px 15px;
            background: transparent;
            font-size: 14px;
        }
        
        .search-btn {
            background: #25D366;
            border: none;
            color: white;
            padding: 10px 15px;
            cursor: pointer;
            font-size: 16px;
            transition: background 0.2s;
        }
        
        .search-btn:hover {
            background: #128C7E;
        }
        
        .header {
            background: linear-gradient(135deg, #25D366 0%, #128C7E 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .user-info h1 {
            margin: 0;
            font-size: 24px;
        }
        
        .user-info p {
            margin: 5px 0 0 0;
            opacity: 0.9;
            font-size: 14px;
        }
        
        .quick-stats {
            display: flex;
            gap: 30px;
        }
        
        .stat-item {
            text-align: center;
        }
        
        .stat-number {
            display: block;
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 4px;
        }
        
        .stat-label {
            display: block;
            font-size: 12px;
            opacity: 0.9;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        @media (max-width: 768px) {
            .nav-bar {
                flex-direction: column;
                gap: 15px;
                padding: 15px;
            }
            
            .nav-left, .nav-right {
                width: 100%;
                justify-content: center;
            }
            
            .nav-center {
                width: 100%;
                max-width: none;
            }
            
            .header {
                flex-direction: column;
                text-align: center;
                gap: 15px;
            }
            
            .quick-stats {
                gap: 20px;
            }
            
            .stat-item {
                flex: 1;
            }
            
            .container {
                padding: 10px;
            }
        }
        
        .tabs {
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .tab-buttons {
            display: flex;
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
        }
        
        .tab-btn {
            flex: 1;
            padding: 15px 20px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            color: #666;
            transition: all 0.3s ease;
            border-bottom: 2px solid transparent;
        }
        
        .tab-btn:hover {
            background: #e9ecef;
            color: #333;
        }
        
        .tab-btn.active {
            color: #25D366;
            background: white;
            border-bottom-color: #25D366;
        }
        
        .tab-content {
            display: none;
            padding: 20px;
            max-height: 600px;
            overflow-y: auto;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* Timeline/Chat styles */
        .timeline-controls {
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .timeline-controls select {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
        
        /* Chat bubble styles */
        .timeline-item {
            display: flex;
            margin-bottom: 15px;
            max-width: 100%;
        }
        
        .timeline-item.user-message {
            justify-content: flex-start;
        }
        
        .timeline-item.bot-message {
            justify-content: flex-end;
        }
        
        .message-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            flex-shrink: 0;
            margin: 0 10px;
        }
        
        .message-avatar.user {
            background: #e3f2fd;
            order: 1;
        }
        
        .message-avatar.bot {
            background: #e8f5e8;
            order: 3;
        }
        
        .message-bubble {
            max-width: 70%;
            padding: 12px 16px;
            border-radius: 18px;
            word-wrap: break-word;
        }
        
        .message-bubble.user {
            background: #e3f2fd;
            color: #1976d2;
            order: 2;
            border-bottom-left-radius: 4px;
        }
        
        .message-bubble.bot {
            background: #25D366;
            color: white;
            order: 2;
            border-bottom-right-radius: 4px;
        }
        
        .message-content-text {
            margin-bottom: 4px;
            white-space: pre-wrap; /* Preserve line breaks in timeline messages too */
            word-wrap: break-word;
        }
        
        .message-meta-chat {
            font-size: 11px;
            opacity: 0.7;
        }
        
        /* Other styles */
        .message-item {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            transition: box-shadow 0.2s;
        }
        
        .message-item:hover {
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        /* Brain dump session styles */
        .brain-dump-session {
            border-left: 4px solid #9c27b0;
            background: linear-gradient(135deg, #f3e5f5 0%, #fafafa 100%);
        }
        
        .brain-dump-session .message-meta {
            color: #7b1fa2;
            font-weight: 600;
        }
        
        .brain-dump-session .message-content {
            border-left: 2px solid #e1bee7;
            padding-left: 12px;
            margin-left: 8px;
        }
        
        .message-content {
            margin-bottom: 10px;
            color: #333;
            white-space: pre-wrap; /* Preserve line breaks and whitespace */
            word-wrap: break-word; /* Handle long words */
        }
        
        .message-meta {
            font-size: 12px;
            color: #666;
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }
        
        .message-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
        }
        
        .tag {
            background: #e3f2fd;
            color: #1976d2;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 500;
        }
        
        .empty-state {
            text-align: center;
            color: #666;
            padding: 40px 20px;
        }
        
        .empty-state h3 {
            margin-bottom: 10px;
            color: #333;
        }
        
        .loading {
            text-align: center;
            color: #666;
            padding: 40px 20px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
        }
        
        .stat-number {
            font-size: 24px;
            font-weight: bold;
            color: #25D366;
            margin-bottom: 5px;
        }
        
        /* Media items */
        .media-item {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .media-icon {
            font-size: 24px;
            width: 40px;
            text-align: center;
        }
        
        .media-info {
            flex: 1;
        }
        
        .media-filename {
            font-weight: 500;
            color: #333;
            margin-bottom: 4px;
        }
        
        .media-details {
            font-size: 12px;
            color: #666;
        }
        
        /* Reminder and birthday items */
        .reminder-item {
            border-left: 4px solid #ff9800;
        }
        
        .birthday-item {
            border-left: 4px solid #e91e63;
        }
        
        /* Brain dump session styling */
        .brain-dump-session {
            border-left: 4px solid #9c27b0;
            background: #f3e5f5;
        }
        
        .brain-dump-session .message-meta {
            color: #7b1fa2;
            font-weight: 500;
        }
        
        .brain-dump-session .message-content {
            white-space: pre-wrap;
            line-height: 1.6;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Navigation Bar -->
        <div class="nav-bar">
            <div class="nav-left">
                <button class="back-btn" onclick="goBack()">
                    <span>←</span> Back to Users
                </button>
            </div>
            <div class="nav-center">
                <div class="search-container">
                    <input type="text" id="searchInput" placeholder="Search messages, content, tags..." class="search-input">
                    <button class="search-btn" onclick="performSearch()">🔍</button>
                </div>
            </div>
            <div class="nav-right">
                <a href="/admin" class="nav-link">Dashboard</a>
                <a href="/admin/users" class="nav-link">All Users</a>
            </div>
        </div>

        <div class="header">
            <div class="user-info">
                <h1>{{ user.get('phone_number', user.get('phone', 'Unknown phone')) }}</h1>
                <p>User ID: {{ user.get('id', 'Unknown') }}</p>
                <p>Last active: {{ user.get('last_seen', user.get('last_activity_date', 'Never')) }}</p>
            </div>
            <div class="quick-stats">
                <div class="stat-item">
                    <span class="stat-number" id="totalMessages">{{ (organized_data.notes|length - organized_data.brain_dumps|length) + organized_data.brain_dump_sessions|length }}</span>
                    <span class="stat-label">Notes</span>
                </div>
                <div class="stat-item">
                    <span class="stat-number">{{ organized_data.reminders|length }}</span>
                    <span class="stat-label">Reminders</span>
                </div>
                <div class="stat-item">
                    <span class="stat-number">{{ organized_data.birthdays|length }}</span>
                    <span class="stat-label">Birthdays</span>
                </div>
                <div class="stat-item">
                    <span class="stat-number">{{ organized_data.voice_notes|length + organized_data.images|length }}</span>
                    <span class="stat-label">Media</span>
                </div>
            </div>
        </div>

        <div class="tabs">
            <div class="tab-buttons">
                <button class="tab-btn active" onclick="showTab('timeline')">Timeline</button>
                <button class="tab-btn" onclick="showTab('notes')">Notes</button>
                <button class="tab-btn" onclick="showTab('media')">Media</button>
                <button class="tab-btn" onclick="showTab('reminders')">Reminders</button>
                <button class="tab-btn" onclick="showTab('birthdays')">Birthdays</button>
                <button class="tab-btn" onclick="showTab('analytics')">Analytics</button>
            </div>

            <!-- Timeline Tab -->
            <div id="timeline" class="tab-content active">
                <div class="timeline-controls">
                    <label for="daysFilter">Show last:</label>
                    <select id="daysFilter" onchange="loadTimeline()">
                        <option value="7">7 days</option>
                        <option value="30" selected>30 days</option>
                        <option value="90">90 days</option>
                        <option value="365">1 year</option>
                        <option value="0">All time</option>
                    </select>
                </div>
                <div id="timelineContent" class="loading">Loading conversation...</div>
            </div>

            <!-- Notes Tab -->
            <div id="notes" class="tab-content">
                {% if organized_data.notes or organized_data.brain_dump_sessions %}
                    <!-- Regular notes -->
                    {% for note in organized_data.notes %}
                        {% if note.get('type') != 'brain_dump' %}
                        <div class="message-item">
                            <div class="message-meta">
                                <span>{{ note.get('message_timestamp', note.get('created_at', 'Unknown date')) }}</span>
                            </div>
                            <div class="message-content">{{ note.get('content', 'No content') }}</div>
                            {% if note.get('tags') %}
                            <div class="message-tags">
                                {% for tag in note.get('tags', []) %}
                                <span class="tag">#{{ tag }}</span>
                                {% endfor %}
                            </div>
                            {% endif %}
                        </div>
                        {% endif %}
                    {% endfor %}
                    
                    <!-- Grouped brain dump sessions -->
                    {% for session in organized_data.brain_dump_sessions %}
                    <div class="message-item brain-dump-session">
                        <div class="message-meta">
                            <span>🧠 Brain Dump Session</span>
                            <span>{{ session.get('start_time', 'Unknown date') }}</span>
                            <small>({{ session.get('messages')|length }} messages)</small>
                        </div>
                        <div class="message-content">{{ session.get('consolidated_content', 'No content') }}</div>
                        {% if session.get('tags') %}
                        <div class="message-tags">
                            {% for tag in session.get('tags', []) %}
                            <span class="tag">#{{ tag }}</span>
                            {% endfor %}
                        </div>
                        {% endif %}
                    </div>
                    {% endfor %}
                    
                    <!-- Individual brain dumps without sessions (fallback) -->
                    {% for note in organized_data.notes %}
                        {% if note.get('type') == 'brain_dump' and not note.get('session_id') %}
                        <div class="message-item">
                            <div class="message-meta">
                                <span>🧠 {{ note.get('message_timestamp', note.get('created_at', 'Unknown date')) }}</span>
                            </div>
                            <div class="message-content">{{ note.get('content', 'No content') }}</div>
                            {% if note.get('tags') %}
                            <div class="message-tags">
                                {% for tag in note.get('tags', []) %}
                                <span class="tag">#{{ tag }}</span>
                                {% endfor %}
                            </div>
                            {% endif %}
                        </div>
                        {% endif %}
                    {% endfor %}
                {% else %}
                    <div class="empty-state">
                        <h3>No notes found</h3>
                        <p>This user hasn't saved any notes yet.</p>
                    </div>
                {% endif %}
            </div>

            <!-- Media Tab -->
            <div id="media" class="tab-content">
                {% if organized_data.voice_notes or organized_data.images or organized_data.documents %}
                    {% for media in organized_data.voice_notes %}
                    <div class="message-item media-item">
                        <div class="media-icon">🎤</div>
                        <div class="media-info">
                            <div class="media-filename">Voice Note</div>
                            <div class="media-details">
                                <span class="timestamp" data-timestamp="{{ media.get('message_timestamp', media.get('created_at', '')) }}">
                                    {{ media.get('message_timestamp', media.get('created_at', 'Unknown date')) }}
                                </span>
                            </div>
                        </div>
                        {% if media.get('tags') %}
                        <div class="message-tags">
                            {% for tag in media.get('tags', []) %}
                            <span class="tag">#{{ tag }}</span>
                            {% endfor %}
                        </div>
                        {% endif %}
                    </div>
                    {% endfor %}
                    {% for media in organized_data.images %}
                    <div class="message-item media-item">
                        <div class="media-icon">📷</div>
                        <div class="media-info">
                            <div class="media-filename">
                                {% if media.get('file_info') and media.file_info.get('original_filename') %}
                                    {{ media.file_info.original_filename }}
                                {% elif media.get('metadata') and media.metadata.get('original_filename') %}
                                    {{ media.metadata.original_filename }}
                                {% else %}
                                    Image
                                {% endif %}
                            </div>
                            <div class="media-details">
                                <span class="timestamp" data-timestamp="{{ media.get('message_timestamp', media.get('created_at', '')) }}">
                                    {{ media.get('message_timestamp', media.get('created_at', 'Unknown date')) }}
                                </span>
                            </div>
                            {% if media.get('media_url') %}
                                <div class="media-preview">
                                    <a href="{{ media.media_url }}" target="_blank">
                                        <img src="{{ media.media_url }}" alt="Image" style="max-width: 200px; max-height: 150px; border-radius: 8px; margin-top: 10px;">
                                    </a>
                                </div>
                            {% elif media.get('file_info') and media.file_info.get('public_url') %}
                                <div class="media-preview">
                                    <a href="{{ media.file_info.public_url }}" target="_blank">
                                        <img src="{{ media.file_info.public_url }}" alt="Image" style="max-width: 200px; max-height: 150px; border-radius: 8px; margin-top: 10px;">
                                    </a>
                                </div>
                            {% else %}
                                <div class="media-link">
                                    <em>Image file (preview not available)</em>
                                </div>
                            {% endif %}
                        </div>
                        {% if media.get('tags') %}
                        <div class="message-tags">
                            {% for tag in media.get('tags', []) %}
                            <span class="tag">#{{ tag }}</span>
                            {% endfor %}
                        </div>
                        {% endif %}
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="empty-state">
                        <h3>No media found</h3>
                        <p>This user hasn't shared any media files yet.</p>
                    </div>
                {% endif %}
            </div>

            <!-- Reminders Tab -->
            <div id="reminders" class="tab-content">
                {% if organized_data.reminders %}
                    {% for reminder in organized_data.reminders %}
                    <div class="message-item reminder-item">
                        <div class="message-meta">
                            <span>⏰ {{ reminder.get('trigger_time', 'No time set') }}</span>
                            <span>{{ 'Active' if reminder.get('is_active', False) else 'Completed' }}</span>
                        </div>
                        <div class="message-content">
                            <strong>{{ reminder.get('title', 'No title') }}</strong>
                            {% if reminder.get('description') %}
                            <p>{{ reminder.get('description') }}</p>
                            {% endif %}
                        </div>
                        {% if reminder.get('tags') %}
                        <div class="message-tags">
                            {% for tag in reminder.get('tags', []) %}
                            <span class="tag">#{{ tag }}</span>
                            {% endfor %}
                        </div>
                        {% endif %}
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="empty-state">
                        <h3>No reminders found</h3>
                        <p>This user hasn't set any reminders yet.</p>
                    </div>
                {% endif %}
            </div>

            <!-- Birthdays Tab -->
            <div id="birthdays" class="tab-content">
                {% if organized_data.birthdays %}
                    {% for birthday in organized_data.birthdays %}
                    <div class="message-item birthday-item">
                        <div class="message-meta">
                            <span>🎂 {{ birthday.get('person_name', 'Unknown person') }}</span>
                            <span class="birthday-date" data-date="{{ birthday.get('birthdate', '') }}">
                                {{ birthday.get('birthdate', 'No date set') }}
                            </span>
                        </div>
                        {% if birthday.get('notification_settings') %}
                        <div class="message-content">
                            Notifications: {{ birthday.get('notification_settings') }}
                        </div>
                        {% endif %}
                        {% if birthday.get('tags') %}
                        <div class="message-tags">
                            {% for tag in birthday.get('tags', []) %}
                            <span class="tag">#{{ tag }}</span>
                            {% endfor %}
                        </div>
                        {% endif %}
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="empty-state">
                        <h3>No birthdays found</h3>
                        <p>This user hasn't saved any birthdays yet.</p>
                    </div>
                {% endif %}
            </div>

            <!-- Analytics Tab -->
            <div id="analytics" class="tab-content">
                <div id="analyticsContent" class="loading">Loading analytics...</div>
            </div>
        </div>
    </div>

    <script>
        let currentUserId = '{{ user.get("id", "") }}';
        
        function showTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
            
            // Load data if needed
            if (tabName === 'timeline') {
                loadTimeline();
            } else if (tabName === 'analytics') {
                loadAnalytics();
            }
        }

        async function loadTimeline() {
            const days = document.getElementById('daysFilter').value;
            const content = document.getElementById('timelineContent');
            content.innerHTML = '<div class="loading">Loading conversation...</div>';
            
            try {
                // Use the conversation endpoint for proper chat-style display
                const response = await fetch(`/admin/api/conversation/${currentUserId}?days=${days}`);
                const data = await response.json();
                
                if (data.status === 'success') {
                    displayConversation(data.conversation || data.messages);
                } else {
                    content.innerHTML = `<div class="empty-state"><h3>Error</h3><p>${data.message}</p></div>`;
                }
            } catch (error) {
                content.innerHTML = `<div class="empty-state"><h3>Error</h3><p>Failed to load conversation: ${error.message}</p></div>`;
            }
        }

        // Helper function to format timestamp with better timezone handling
        function formatMessageDate(timestamp) {
            if (!timestamp) return 'Unknown date';
            
            try {
                let date;
                
                // If it's already a Date object
                if (timestamp instanceof Date) {
                    date = timestamp;
                }
                // If it's a Unix timestamp (number)
                else if (typeof timestamp === 'number') {
                    date = new Date(timestamp * 1000);
                }
                // If it's a string
                else {
                    // Handle various timestamp formats
                    let cleanTimestamp = timestamp;
                    
                    // If timestamp doesn't have timezone info, assume UTC
                    if (typeof cleanTimestamp === 'string') {
                        // If it doesn't end with Z or timezone offset, assume it's UTC
                        if (!cleanTimestamp.match(/[Zz]$/) && !cleanTimestamp.match(/[+-]\d{2}:\d{2}$/)) {
                            cleanTimestamp += '+00:00';
                        }
                    }
                    
                    date = new Date(cleanTimestamp);
                }
                
                // Check if date is valid
                if (isNaN(date.getTime())) {
                    console.warn('Invalid date:', timestamp);
                    return 'Invalid date';
                }
                
                // Always format in user's local timezone
                const options = {
                    year: 'numeric',
                    month: 'short', 
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit',
                    hour12: false
                };
                
                return date.toLocaleString('en-US', options);
                
            } catch (error) {
                console.error('Error formatting date:', error, 'Timestamp:', timestamp);
                return 'Invalid date';
            }
        }

        function displayConversation(messages) {
            const content = document.getElementById('timelineContent');
            
            if (!messages || messages.length === 0) {
                content.innerHTML = '<div class="empty-state"><h3>No messages found</h3><p>No messages in the selected time period.</p></div>';
                return;
            }

            // Sort messages by timestamp (newest first)
            messages.sort((a, b) => {
                const timestampA = a.timestamp || a.message_timestamp || a.created_at;
                const timestampB = b.timestamp || b.message_timestamp || b.created_at;
                
                if (!timestampA && !timestampB) return 0;
                if (!timestampA) return 1;
                if (!timestampB) return -1;
                
                try {
                    const dateA = new Date(timestampA);
                    const dateB = new Date(timestampB);
                    
                    // Check for invalid dates
                    if (isNaN(dateA.getTime()) && isNaN(dateB.getTime())) return 0;
                    if (isNaN(dateA.getTime())) return 1;
                    if (isNaN(dateB.getTime())) return -1;
                    
                    return dateB - dateA; // Descending order (newest first)
                } catch (error) {
                    console.error('Error sorting dates:', error, timestampA, timestampB);
                    return 0;
                }
            });

            let html = '';
            messages.forEach(message => {
                // Debug logging for brain dumps
                if (message.type === 'brain_dump') {
                    console.log('Processing brain dump message:', {
                        id: message.id,
                        type: message.type,
                        content: message.content,
                        tags: message.tags,
                        timestamp: message.message_timestamp
                    });
                }
                
                const date = formatMessageDate(message.timestamp || message.message_timestamp || message.created_at);
                let icon = '👤';
                let bubbleClass = 'user';
                let timelineClass = 'user-message';
                let avatarClass = 'user';
                
                // Check if this is a bot response
                const isBotResponse = (
                    message.is_bot_response ||
                    (message.metadata && message.metadata.sender === 'bot') ||
                    (message.tags && message.tags.includes('bot-response')) ||
                    (message.content && message.content.startsWith('🤖'))
                );
                
                if (isBotResponse) {
                    icon = '🤖';
                    bubbleClass = 'bot';
                    timelineClass = 'bot-message';
                    avatarClass = 'bot';
                } else {
                    // Different icons for different message types
                    if (message.type === 'reminder') {
                        icon = '⏰';
                    } else if (message.type === 'birthday') {
                        icon = '🎂';
                    } else if (message.type === 'brain_dump') {
                        icon = '🧠';
                    } else if (message.source_type === 'audio') {
                        icon = '🎤';
                    } else if (message.source_type === 'image') {
                        icon = '📷';
                    }
                }

                const messageContent = message.content || 'No content';
                const cleanContent = isBotResponse && messageContent.startsWith('🤖') ? 
                    messageContent.substring(2).trim() : messageContent;
                
                // Escape HTML to prevent rendering issues with special characters
                const escapeHtml = (text) => {
                    const div = document.createElement('div');
                    div.textContent = text;
                    return div.innerHTML;
                };
                
                const safeContent = escapeHtml(cleanContent);

                // Handle media content
                let mediaHtml = '';
                if (message.media_url) {
                    if (message.source_type === 'image') {
                        mediaHtml = `<div class="message-media">
                            <a href="${message.media_url}" target="_blank">
                                <img src="${message.media_url}" alt="Image" style="max-width: 250px; max-height: 200px; border-radius: 8px; margin-top: 8px; cursor: pointer;">
                            </a>
                        </div>`;
                    } else if (message.source_type === 'audio') {
                        mediaHtml = `<div class="message-media">
                            <audio controls style="margin-top: 8px;">
                                <source src="${message.media_url}" type="audio/mpeg">
                                Your browser does not support the audio element.
                            </audio>
                        </div>`;
                    } else if (message.source_type === 'document') {
                        mediaHtml = `<div class="message-media">
                            <a href="${message.media_url}" target="_blank" style="display: inline-block; margin-top: 8px; padding: 8px 12px; background: rgba(255,255,255,0.1); border-radius: 6px; text-decoration: none; color: inherit;">
                                📄 View Document
                            </a>
                        </div>`;
                    }
                }

                html += `
                    <div class="timeline-item ${timelineClass}">
                        <div class="message-avatar ${avatarClass}">${icon}</div>
                        <div class="message-bubble ${bubbleClass}">
                            <div class="message-content-text">${safeContent}</div>
                            ${mediaHtml}
                            <div class="message-meta-chat">${date}</div>
                        </div>
                    </div>
                `;
            });
            
            content.innerHTML = html;
        }

        async function loadAnalytics() {
            const content = document.getElementById('analyticsContent');
            content.innerHTML = '<div class="loading">Loading analytics...</div>';
            
            try {
                const response = await fetch(`/admin/user/api/users/${currentUserId}/stats`);
                const data = await response.json();
                
                if (data.status === 'success') {
                    displayAnalytics(data.stats);
                } else {
                    content.innerHTML = `<div class="empty-state"><h3>Error</h3><p>${data.message}</p></div>`;
                }
            } catch (error) {
                content.innerHTML = `<div class="empty-state"><h3>Error</h3><p>Failed to load analytics: ${error.message}</p></div>`;
            }
        }

        function displayAnalytics(stats) {
            const content = document.getElementById('analyticsContent');
            
            let html = `
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number">${stats.total_messages}</div>
                        <div>Total Messages</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${stats.total_files}</div>
                        <div>Media Files</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${stats.total_reminders}</div>
                        <div>Reminders</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${stats.total_birthdays}</div>
                        <div>Birthdays</div>
                    </div>
                </div>
                
                <h3>Message Types</h3>
                <div class="message-item">
            `;
            
            for (const [type, count] of Object.entries(stats.messages_by_type)) {
                html += `<div>${type}: ${count}</div>`;
            }
            
            html += `</div><h3>Top Tags</h3><div class="message-tags">`;
            
            for (const [tag, count] of Object.entries(stats.most_used_tags)) {
                html += `<span class="tag">#${tag} (${count})</span>`;
            }
            
            html += `</div>`;
            
            content.innerHTML = html;
        }

        // Load timeline on page load
        window.onload = function() {
            loadTimeline();
        };
        
        // Navigation functions
        function goBack() {
            window.location.href = '/admin/users';
        }
        
        // Search functionality
        function performSearch() {
            const searchTerm = document.getElementById('searchInput').value.trim();
            if (searchTerm) {
                searchInContent(searchTerm);
            } else {
                // Reset to show all content
                loadTimeline();
            }
        }
        
        // Search in current content
        function searchInContent(searchTerm) {
            const content = document.getElementById('timelineContent');
            const searchLower = searchTerm.toLowerCase();
            
            // Get current messages from the timeline
            const timelineItems = content.querySelectorAll('.timeline-item');
            let foundItems = [];
            
            timelineItems.forEach(item => {
                const messageText = item.querySelector('.message-content-text');
                if (messageText && messageText.textContent.toLowerCase().includes(searchLower)) {
                    foundItems.push(item.cloneNode(true));
                }
            });
            
            if (foundItems.length > 0) {
                content.innerHTML = `
                    <div style="background: #e3f2fd; padding: 10px; border-radius: 5px; margin-bottom: 15px;">
                        <strong>Search Results for "${searchTerm}"</strong> - ${foundItems.length} matches found
                        <button onclick="clearSearch()" style="float: right; background: none; border: none; color: #666; cursor: pointer;">✕ Clear</button>
                    </div>
                `;
                foundItems.forEach(item => {
                    // Highlight search term
                    const messageText = item.querySelector('.message-content-text');
                    if (messageText) {
                        const highlighted = messageText.innerHTML.replace(
                            new RegExp(`(${searchTerm})`, 'gi'),
                            '<mark style="background: yellow; padding: 2px;">$1</mark>'
                        );
                        messageText.innerHTML = highlighted;
                    }
                    content.appendChild(item);
                });
            } else {
                content.innerHTML = `
                    <div class="empty-state">
                        <h3>No matches found</h3>
                        <p>No messages contain "${searchTerm}"</p>
                        <button onclick="clearSearch()" class="tab-btn" style="margin-top: 10px;">Show All Messages</button>
                    </div>
                `;
            }
        }
        
        function clearSearch() {
            document.getElementById('searchInput').value = '';
            loadTimeline();
        }
        
        // Enter key search
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('searchInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    performSearch();
                }
            });

            // Format all timestamps on page load
            formatPageTimestamps();
            
            // Format birthday dates to show only day/month
            formatBirthdayDates();
        });

        function formatPageTimestamps() {
            // Format all timestamps with data-timestamp attribute
            const timestampElements = document.querySelectorAll('.timestamp[data-timestamp]');
            timestampElements.forEach(function(element) {
                const timestamp = element.getAttribute('data-timestamp');
                if (timestamp) {
                    const formatted = formatMessageDate(timestamp);
                    element.textContent = formatted;
                }
            });
        }

        function formatBirthdayDates() {
            const birthdayDates = document.querySelectorAll('.birthday-date[data-date]');
            birthdayDates.forEach(function(dateElement) {
                const dateStr = dateElement.getAttribute('data-date');
                if (dateStr && dateStr !== '' && dateStr !== 'No date set') {
                    try {
                        const date = new Date(dateStr);
                        const monthNames = ["January", "February", "March", "April", "May", "June",
                            "July", "August", "September", "October", "November", "December"];
                        const formattedDate = monthNames[date.getMonth()] + ' ' + date.getDate();
                        dateElement.textContent = formattedDate;
                    } catch (e) {
                        console.log('Error formatting date:', dateStr, e);
                    }
                }
            });
        }
    </script>
</body>
</html>
